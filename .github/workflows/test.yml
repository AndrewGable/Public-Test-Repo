# This is a basic workflow to help you get started with Actions

name: CI

# Controls when the action will run.
on:
  pull_request:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      IS_DEPLOYER: ${{ fromJSON(steps.isFakeTeamMember.outputs.isTeamMember) || github.actor == 'roryabraham' }}
    steps:
      - uses: actions/checkout@v2

      - id: isTeamMember
        uses: tspascoal/get-user-teams-membership@baf2e6adf4c3b897bd65a7e3184305c165aec872
        with:
          GITHUB_TOKEN: ${{ secrets.RORY_TOKEN }}
          username: ${{ github.actor }}
          team: rory-custom-team

      - id: isFakeTeamMember
        uses: tspascoal/get-user-teams-membership@baf2e6adf4c3b897bd65a7e3184305c165aec872
        with:
          GITHUB_TOKEN: ${{ secrets.RORY_TOKEN }}
          username: ${{ github.actor }}
          team: fake-team

      - name: Get PR Ã§ount for ${{ github.actor }}'s with apostrophe
        run: echo "PR_COUNT=$(gh pr list --author roryabraham --state any | grep -c "")" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - if: ${{ fromJSON(env.PR_COUNT) == 22 }}
        run: echo "22 PRs!"

      - if: ${{ fromJSON(env.PR_COUNT) != 22 }}
        run: echo "Some other number of PRs"

      # Should be true
      - run: echo ${{ fromJSON(steps.isTeamMember.outputs.isTeamMember) }}

      # Should be false
      - run: echo ${{ fromJSON(steps.isFakeTeamMember.outputs.isTeamMember) }}

      # Should be true
      - run: echo ${{ github.actor == 'roryabraham' }}

      # Should be false
      - run: echo ${{ github.actor == 'AndrewGable' }}

      # Should be true
      - run: echo ${{ fromJSON(steps.isFakeTeamMember.outputs.isTeamMember) || github.actor == 'roryabraham' }}

      # Should be true
      - run: echo ${{ github.actor == 'roryabraham' || fromJSON(steps.isFakeTeamMember.outputs.isTeamMember) }}

      # Should be true
      - run: echo ${{ github.actor == 'AndrewGable' || fromJSON(steps.isTeamMember.outputs.isTeamMember) }}

      # Should be false
      - run: echo ${{ github.actor == 'AndrewGable' || fromJSON(steps.isFakeTeamMember.outputs.isTeamMember) }}

      # Should be true
      - run: echo ${{ fromJSON(steps.isTeamMember.outputs.isTeamMember) || github.actor == 'AndrewGable' }}


  # This workflow contains a single job called "build"
  build:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest
    needs: validate

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      - run: echo ${{ needs.validate.outputs.IS_DEPLOYER }}

      - run: echo ${{ fromJSON(needs.validate.outputs.IS_DEPLOYER) }}

      - if: ${{ fromJSON(needs.validate.outputs.IS_DEPLOYER) }}
        run: echo "${{ github.actor }} is a deployer"

      - if: ${{ !fromJSON(needs.validate.outputs.IS_DEPLOYER) }}
        run: echo "${{ github.actor }} is not a deployer"
